<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>效期查询</title>
    <link rel="stylesheet" href="../statics/github.css">
    <link rel="stylesheet" href="../statics/theme.css">
    <style>
        .searchbox {
            width: 100%;
            white-space: nowrap;
            margin-bottom: 15px;
        }

        #keyword {
            width: 80%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #search {
            width: 15%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #search:hover {
            background-color: #0056b3;
        }

        .clear-search {
            width: 15%;
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }

        .clear-search:hover {
            background-color: #5a6268;
        }

        .pure-table {
            width: 100%;
            font-size: small;
            table-layout: fixed; /* 固定表格布局 */
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pure-table caption {
            font-style: normal;
            font-weight: bold;
            font-size: 14px;
            padding: 8px;
            background-color: #f5f5f5;
            text-align: left;
        }

        .pure-table th,
        .pure-table td {
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
            word-wrap: break-word; /* 长文本自动换行 */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pure-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* 对照品表格的列宽设置（6列） */
        .pure-table th:nth-child(1), /* 名称 */
        .pure-table td:nth-child(1) {
            width: 25%; /* 药品名称需要较多空间 */
            text-align: left;
        }

        .pure-table th:nth-child(2), /* 批号 */
        .pure-table td:nth-child(2) {
            width: 12%;
        }

        .pure-table th:nth-child(3), /* 有效期至 */
        .pure-table td:nth-child(3) {
            width: 10%;
        }

        .pure-table th:nth-child(4), /* 含量丨纯度 */
        .pure-table td:nth-child(4) {
            width: 8%;
        }

        .pure-table th:nth-child(5), /* 来源 */
        .pure-table td:nth-child(5) {
            width: 20%;
        }

        .pure-table th:nth-child(6), /* 页码 */
        .pure-table td:nth-child(6) {
            width: 5%;
        }

        /* 设备表格的特殊列宽设置（3列） */
        .pure-table:has(caption:contains("设备信息")) th:nth-child(1), /* 设备名称 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(1) {
            width: 50%;
            text-align: left;
        }

        .pure-table:has(caption:contains("设备信息")) th:nth-child(2), /* 设备编号 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(2) {
            width: 20%;
        }

        .pure-table:has(caption:contains("设备信息")) th:nth-child(3), /* 设备有效期至 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(3) {
            width: 15%;
        }

        .expir30 {
            color: orange;
            font-weight: bold;
        }

        .expir7 {
            color: red;
            font-weight: bold;
        }

        .expired {
            color: red;
            text-decoration: line-through;
            font-weight: bold;
        }

        #content {
            overflow-x: auto; /* 小屏幕时横向滚动 */
            margin-bottom: 15px;
        }

        .stats {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            #keyword {
                width: 70%;
            }
            #search, .clear-search {
                width: 25%;
                margin-left: 0;
                margin-top: 5px;
            }
            
            .pure-table th:nth-child(1),
            .pure-table td:nth-child(1) {
                width: 20%;
            }
            
            .pure-table th:nth-child(5),
            .pure-table td:nth-child(5) {
                width: 30%;
            }
        }
    </style>
    <script src="../statics/modules/jquery.min.js"></script>
    <script>
        // 可用于查询的数据
        const databases = [
            {
                "name": "device",
                "path": "../statics/info/device.json"
            },
            {
                "name": "standard",
                "path": "../statics/info/standard.json"
            }
        ]

        let info = {}
        let allData = {
            device: [],
            standard: []
        }
        
        $(() => {
            let count = databases.length
            let loadedDevice = false
            let loadedStandard = false

            // 加载所有数据
            for (const database of databases) {
                $.getJSON(database.path, (data) => {
                    info[database.name] = data
                    allData[database.name] = data // 保存所有数据
                    count = --count
                    
                    switch (database.name) {
                        case "device":
                            loadedDevice = true
                            break
                        case "standard":
                            loadedStandard = true
                            break
                    }
                    
                    // 当两个数据都加载完成时，显示所有数据
                    if (loadedDevice && loadedStandard) {
                        displayAllData()
                        $("#content").prepend(`<div class="stats">已加载设备数据 ${allData.device.length} 条，对照品数据 ${allData.standard.length} 条</div>`)
                    }
                }).fail(() => {
                    count = --count
                    $("#content").append(`<p style="color: red">加载${database.name}数据失败</p>`)
                })
            }

            // 搜索按钮点击事件
            $("#search").click(() => {
                performSearch()
            })
            
            // 清除搜索按钮
            $("body").append('<button class="clear-search" id="clearSearch" style="display:none;">清除搜索</button>')
            
            $("#clearSearch").click(() => {
                $("#keyword").val("")
                performSearch()
            })
            
            // 添加回车键搜索功能
            $("#keyword").keypress(function(e) {
                if (e.which == 13) {
                    performSearch()
                }
            });
            
            // 实时搜索（可选，可根据需要开启）
            // $("#keyword").on("input", function() {
            //     performSearch()
            // });
        })
        
        function performSearch() {
            let keyword = $("#keyword").val().toLowerCase().trim()
            $("#content").empty()
            
            if (keyword === "") {
                // 如果搜索框为空，显示所有数据
                displayAllData()
                $("#clearSearch").hide()
                $("#content").prepend(`<div class="stats">显示全部数据：设备 ${allData.device.length} 条，对照品 ${allData.standard.length} 条</div>`)
            } else {
                // 执行搜索
                let searchResults = searchAllData(keyword)
                $("#clearSearch").show()
                $("#content").prepend(`<div class="stats">搜索"${keyword}"找到 ${searchResults.device.length} 条设备记录，${searchResults.standard.length} 条对照品记录</div>`)
            }
        }
        
        function searchAllData(keyword) {
            // 搜索设备数据（可搜索多个字段）
            let device = allData.device.filter((value) => {
                // 搜索编号、名称等字段
                return (value.id && value.id.toLowerCase().includes(keyword)) ||
                       (value.name && value.name.toLowerCase().includes(keyword)) ||
                       (value.where && value.where.toLowerCase().includes(keyword))
            })
            
            // 搜索对照品数据（可搜索多个字段）
            let standard = allData.standard.filter((value) => {
                // 搜索批号、名称、来源等字段
                return (value.batch && value.batch.toLowerCase().includes(keyword)) ||
                       (value.kind && value.kind.toLowerCase().includes(keyword)) ||
                       (value.source && value.source.toLowerCase().includes(keyword)) ||
                       (value.content && value.content.toLowerCase().includes(keyword))
            })
            
            // 显示搜索结果
            if (device.length > 0) {
                let table_device = createDeviceTable(device)
                $("#content").append(table_device)
            }
            
            if (standard.length > 0) {
                let table_standard = createStandardTable(standard)
                $("#content").append(table_standard)
            }
            
            // 如果没有搜索结果，显示提示
            if (device.length === 0 && standard.length === 0) {
                $("#content").append("<p>没有找到匹配的记录，请尝试其他关键词</p>")
            }
            
            return { device, standard }
        }
        
        function displayAllData() {
            // 显示所有设备数据
            if (allData.device.length > 0) {
                let table_device = createDeviceTable(allData.device)
                $("#content").append(table_device)
            }
            
            // 显示所有对照品数据
            if (allData.standard.length > 0) {
                let table_standard = createStandardTable(allData.standard)
                $("#content").append(table_standard)
            }
        }

        function createDeviceTable(data) {
            return createTable(data, `设备信息（${data.length}条）`, ["名称", "编号", "有效期至"], ["where"])
        }

        function createStandardTable(data) {
            return createTable(data, `对照品信息（${data.length}条）`, ["名称","批号", "有效期至", "含量丨纯度", "来源", "页码"], [])
        }

        function createTable(data, captionText, header, hidden = []) {
            let table = document.createElement("table")
            table.setAttribute("class", "pure-table")

            let caption = document.createElement("caption")
            caption.innerText = captionText
            table.appendChild(caption)

            let tr = document.createElement("tr")
            for (const headerText of header) {
                let th = document.createElement("th")
                th.innerText = headerText
                tr.appendChild(th)
            }
            table.appendChild(tr)

            data.forEach(element => {
                let tr = document.createElement("tr")
                
                // 按照表头顺序添加数据
                for (let i = 0; i < header.length; i++) {
                    let td = document.createElement("td")
                    let value = ""
                    
                    switch(header[i]) {
                        case "名称":
                            value = element.kind || element.name || ""
                            break
                        case "批号":
                            value = element.batch || ""
                            break
                        case "有效期至":
                            value = element.expir ? checkExpir(element.expir) : ""
                            break
                        case "含量丨纯度":
                            value = element.content || ""
                            break
                        case "来源":
                            value = element.source || ""
                            break
                        case "页码":
                            value = element.page || ""
                            break
                        case "编号":
                            value = element.id || ""
                            break
                        default:
                            break
                    }
                    
                    td.innerHTML = value
                    tr.appendChild(td)
                }
                table.appendChild(tr)
            })

            return table
        }

        function checkExpir(value) {
            if (!value || value === '/' || value === '') {
                return value
            }
            
            // 处理 "2023.07" 这种格式
            let date = new Date()
            let array = value.split(".")
            
            // 设置年份和月份
            date.setFullYear(array[0])
            date.setMonth(array[1] - 1)
            
            // 如果没有日期，设置为当月的最后一天
            if (array.length === 2) {
                date.setDate(1)
                date.setMonth(date.getMonth() + 1)
                date.setDate(0) // 设置为上个月的最后一天
            } else {
                date.setDate(array[2])
            }
            
            let day = (date - Date.now()) / 86400000

            if (day <= 0) {
                return `<span class='expired'>${value}</span>`
            }

            if (day <= 7) {
                return `<span class='expir7'>${value}</span>`
            }

            if (day <= 30) {
                return `<span class='expir30'>${value}</span>`
            }

            return value
        }
    </script>
</head>

<body>
    <div class="searchbox">
        <input type="text" name="keyword" id="keyword" placeholder="输入批号、名称、来源等关键词搜索（忽略大小写）">
        <button type="submit" id="search">搜索</button>
    </div>

    <div id="content">
        <p>正在加载数据...</p>
    </div>
    <div>
        <p>
            搜索说明：<br>
            - 支持模糊搜索，可搜索批号、药品名称、来源等字段<br>
            - 搜索框为空时显示全部数据<br>
            - 按回车键或点击搜索按钮开始搜索<br>
            <br>
            过期提醒：<br>
            <span class="expir30">黄色表示有效期剩余 30 天</span><br>
            <span class="expir7">红色表示有效期剩余 7 天</span><br>
            <span class="expired">红色加删除线表示已过期</span><br>
        </p>
    </div>
</body>

</html>
