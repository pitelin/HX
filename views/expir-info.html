<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>效期查询</title>
    <link rel="stylesheet" href="../statics/github.css">
    <link rel="stylesheet" href="../statics/theme.css">
    <style>
        .searchbox {
            width: 100%;
            white-space: nowrap;
            margin-bottom: 15px;
        }

        #keyword {
            width: 80%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #search {
            width: 15%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #search:hover {
            background-color: #0056b3;
        }

        .pure-table {
            width: 100%;
            font-size: small;
            table-layout: fixed; /* 固定表格布局 */
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pure-table caption {
            font-style: normal;
            font-weight: bold;
            font-size: 14px;
            padding: 8px;
            background-color: #f5f5f5;
            text-align: left;
        }

        .pure-table th,
        .pure-table td {
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
            word-wrap: break-word; /* 长文本自动换行 */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pure-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* 对照品表格的列宽设置（6列） */
        .pure-table th:nth-child(1), /* 名称 */
        .pure-table td:nth-child(1) {
            width: 25%; /* 药品名称需要较多空间 */
            text-align: left;
        }

        .pure-table th:nth-child(2), /* 批号 */
        .pure-table td:nth-child(2) {
            width: 12%;
        }

        .pure-table th:nth-child(3), /* 有效期至 */
        .pure-table td:nth-child(3) {
            width: 10%;
        }

        .pure-table th:nth-child(4), /* 含量丨纯度 */
        .pure-table td:nth-child(4) {
            width: 8%;
        }

        .pure-table th:nth-child(5), /* 来源 */
        .pure-table td:nth-child(5) {
            width: 20%;
        }

        .pure-table th:nth-child(6), /* 页码 */
        .pure-table td:nth-child(6) {
            width: 5%;
        }

        /* 设备表格的特殊列宽设置（3列） */
        .pure-table:has(caption:contains("设备信息")) th:nth-child(1), /* 设备名称 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(1) {
            width: 50%;
            text-align: left;
        }

        .pure-table:has(caption:contains("设备信息")) th:nth-child(2), /* 设备编号 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(2) {
            width: 20%;
        }

        .pure-table:has(caption:contains("设备信息")) th:nth-child(3), /* 设备有效期至 */
        .pure-table:has(caption:contains("设备信息")) td:nth-child(3) {
            width: 15%;
        }

        .expir30 {
            color: orange;
            font-weight: bold;
        }

        .expir7 {
            color: red;
            font-weight: bold;
        }

        .expired {
            color: red;
            text-decoration: line-through;
            font-weight: bold;
        }

        #content {
            overflow-x: auto; /* 小屏幕时横向滚动 */
            margin-bottom: 15px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            #keyword {
                width: 70%;
            }
            #search {
                width: 25%;
            }
            
            .pure-table th:nth-child(1),
            .pure-table td:nth-child(1) {
                width: 20%;
            }
            
            .pure-table th:nth-child(5),
            .pure-table td:nth-child(5) {
                width: 30%;
            }
        }
        
        /* 搜索统计信息样式 */
        .search-result-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .search-result-info span {
            font-weight: bold;
            color: #007bff;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
    <script src="../statics/modules/jquery.min.js"></script>
    <script>
        // 可用于查询的数据
        const databases = [
            {
                "name": "device",
                "path": "../statics/info/device.json"
            },
            {
                "name": "standard",
                "path": "../statics/info/standard.json"
            }
        ]

        let info = {}
        $(() => {
            let count = databases.length
            let interval = setInterval(() => {
                if (count == 0) {
                    $("#content").append("<p class='search-result-info'>已加载所有数据，请输入关键词搜索</p>")
                    clearInterval(interval)
                }
            }, 100)

            // 加载所有数据
            for (const database of databases) {
                $.getJSON(database.path, (data) => {
                    info[database.name] = data
                    count = --count
                    switch (database.name) {
                        case "device":
                            $("#content").append(`<p>已加载设备数据，共 ${data.length} 条</p>`)
                            break
                        case "standard":
                            $("#content").append(`<p>已加载对照品数据，共 ${data.length} 条</p>`)
                            break
                        default:
                            break
                    }
                })
            }

            $("#search").click(() => {
                let keyword = $("#keyword").val().trim().toLowerCase()
                $("#content").empty()
                
                if (keyword === "") {
                    $("#content").append("<p class='search-result-info'>请输入搜索关键词</p>")
                    return
                }
                
                searchDevice(keyword)
                searchStandard(keyword)
            })
            
            // 添加回车键搜索功能
            $("#keyword").keypress(function(e) {
                if (e.which == 13) {
                    $("#search").click();
                }
            });
        })

        function searchDevice(keyword) {
            let device = info.device.filter((value) => {
                // 搜索多个字段：名称、编号
                return (value.name && value.name.toLowerCase().includes(keyword)) ||
                       (value.id && value.id.toLowerCase().includes(keyword))
            })
            
            if (device.length > 0) {
                let resultInfo = document.createElement("div")
                resultInfo.className = "search-result-info"
                resultInfo.innerHTML = `设备搜索结果：找到 <span>${device.length}</span> 条匹配记录，关键词："${keyword}"`
                $("#content").append(resultInfo)
                
                let table_device = createDeviceTable(device)
                $("#content").append(table_device)
            } else {
                let noResults = document.createElement("div")
                noResults.className = "no-results"
                noResults.innerHTML = `未找到匹配的设备数据，关键词："${keyword}"`
                $("#content").append(noResults)
            }
        }

        function searchStandard(keyword) {
            let standard = info.standard.filter((value) => {
                // 搜索多个字段：名称、批号、来源、含量
                return (value.kind && value.kind.toLowerCase().includes(keyword)) ||
                       (value.batch && value.batch.toLowerCase().includes(keyword)) ||
                       (value.source && value.source.toLowerCase().includes(keyword)) ||
                       (value.content && value.content.toLowerCase().includes(keyword))
            })
            
            if (standard.length > 0) {
                let resultInfo = document.createElement("div")
                resultInfo.className = "search-result-info"
                resultInfo.innerHTML = `对照品搜索结果：找到 <span>${standard.length}</span> 条匹配记录，关键词："${keyword}"`
                $("#content").append(resultInfo)
                
                let table_standard = createStandardTable(standard)
                $("#content").append(table_standard)
            } else {
                let noResults = document.createElement("div")
                noResults.className = "no-results"
                noResults.innerHTML = `未找到匹配的对照品数据，关键词："${keyword}"`
                $("#content").append(noResults)
            }
        }

        function createDeviceTable(data) {
            return createTable(data, `设备信息（${data.length}条）`, ["名称", "编号", "有效期至"], ["where"])
        }

        function createStandardTable(data) {
            return createTable(data, `对照品信息（${data.length}条）`, ["名称","批号", "有效期至", "含量丨纯度", "来源", "页码"], [])
        }

        function createTable(data, captionText, header, hidden = []) {
            let table = document.createElement("table")
            table.setAttribute("class", "pure-table")

            let caption = document.createElement("caption")
            caption.innerText = captionText
            table.appendChild(caption)

            let tr = document.createElement("tr")
            for (const headerText of header) {
                let th = document.createElement("th")
                th.innerText = headerText
                tr.appendChild(th)
            }
            table.appendChild(tr)

            data.forEach(element => {
                let tr = document.createElement("tr")
                
                // 按照表头顺序添加数据
                for (let i = 0; i < header.length; i++) {
                    let td = document.createElement("td")
                    let value = ""
                    
                    switch(header[i]) {
                        case "名称":
                            value = element.kind || element.name || ""
                            break
                        case "批号":
                            value = element.batch || ""
                            break
                        case "有效期至":
                            value = element.expir ? checkExpir(element.expir) : ""
                            break
                        case "含量丨纯度":
                            value = element.content || ""
                            break
                        case "来源":
                            value = element.source || ""
                            break
                        case "页码":
                            value = element.page || ""
                            break
                        case "编号":
                            value = element.id || ""
                            break
                        default:
                            break
                    }
                    
                    td.innerHTML = value
                    tr.appendChild(td)
                }
                table.appendChild(tr)
            })

            return table
        }

        function checkExpir(value) {
            if (!value || value === '/' || value === '') {
                return value
            }
            
            // 处理只有年月的情况（如2023.07）
            let array = value.split(".")
            if (array.length < 3) {
                // 如果是只有年月，补上日
                array.push("01")
            }
            
            let date = new Date()
            date.setFullYear(array[0], array[1] - 1, array[2])

            let day = (date - Date.now()) / 86400000

            if (day <= 0) {
                return `<span class='expired'>${value}</span>`
            }

            if (day <= 7) {
                return `<span class='expir7'>${value}</span>`
            }

            if (day <= 30) {
                return `<span class='expir30'>${value}</span>`
            }

            return value
        }
    </script>
</head>

<body>
    <div class="searchbox">
        <input type="text" name="keyword" id="keyword" placeholder="输入药品名称、批号、来源或含量进行搜索">
        <button type="submit" id="search">搜索</button>
    </div>

    <div id="content">
        <p class="search-result-info">数据加载中，请稍候...</p>
    </div>
    <div>
        <p>
            <strong>搜索说明：</strong><br>
            1. 可以搜索药品名称（支持模糊搜索，如输入"左乙拉西坦"或"杂质G"）<br>
            2. 可以搜索批号（如"K2016151"）<br>
            3. 可以搜索来源（如"阿拉丁"、"海欣"）<br>
            4. 可以搜索含量（如"99.2%"）<br>
            5. 搜索不区分大小写<br><br>
            
            <strong>过期提醒：</strong><br>
            <span class="expir30">黄色表示有效期剩余 30 天</span><br>
            <span class="expir7">红色表示有效期剩余 7 天</span><br>
            <span class="expired">红色加删除线表示已过期</span><br>
        </p>
    </div>
</body>

</html>
